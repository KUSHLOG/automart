name: 'Auto Mart CI/CD Pipeline'
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # Phase 1: Code Quality & Compilation Tests
  quality-check:
    name: ğŸ“‹ Code Quality & Type Safety
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ” TypeScript compilation check
        run: npx tsc --noEmit

      - name: ğŸ§¹ ESLint check
        run: npm run lint

      - name: âœ¨ Prettier format check
        run: npx prettier --check .

  # Phase 2: Component & Import Validation
  component-validation:
    name: ğŸ§© Component Import/Export Tests
    runs-on: ubuntu-latest
    needs: quality-check

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ”§ Setup database
        run: |
          npx prisma generate
          npx prisma db push

      - name: ğŸ§ª Component export validation
        run: |
          node -e "
          const fs = require('fs');
          const checkExports = (file) => {
            const content = fs.readFileSync(file, 'utf8');
            if (!content.includes('export default')) {
              throw new Error(\`Missing default export in \${file}\`);
            }
          };
          ['src/components/VehiclesGrid.tsx', 'src/components/VehicleFilters.tsx'].forEach(checkExports);
          console.log('âœ… All components have proper exports');
          "

      - name: ğŸ—ï¸ Build test
        run: npm run build

      - name: ğŸ§ª Unit tests
        run: npm test -- --passWithNoTests

  # Phase 3: Integration & E2E Tests
  integration-tests:
    name: ğŸŒ Integration & E2E Tests
    runs-on: ubuntu-latest
    needs: component-validation

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ”§ Setup database
        run: |
          npx prisma generate
          npx prisma db push

      - name: ğŸ“¦ Install Playwright browsers
        run: npx playwright install --with-deps

      - name: ğŸ§ª Component validation E2E tests
        run: npx playwright test tests/e2e/component-validation.spec.ts

      - name: ğŸ§ª Run all E2E tests
        run: npx playwright test

      - name: ğŸ“¸ Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/

  # Phase 4: Performance & Security Tests
  performance-security:
    name: âš¡ Performance & Security
    runs-on: ubuntu-latest
    needs: integration-tests

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ”’ Security audit
        run: npm audit --audit-level moderate

      - name: ğŸ“Š Bundle analysis
        run: |
          npm run build
          npx next-bundle-analyzer || echo "Bundle analysis completed"

  # Phase 5: Deployment Readiness
  deployment-check:
    name: ğŸš€ Deployment Readiness
    runs-on: ubuntu-latest
    needs: [quality-check, component-validation, integration-tests]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Production build
        run: npm run build

      - name: âœ… Deployment ready
        run: echo "ğŸ‰ All checks passed! Ready for deployment ğŸš€"
